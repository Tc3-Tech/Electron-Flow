<!DOCTYPE html>
<html>
<head>
    <title>Material Flow Demo</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function MaterialFlow() {
            const [material, setMaterial] = React.useState('copper');
            const [isFlowing, setIsFlowing] = React.useState(false);
            const [atoms, setAtoms] = React.useState([]);
            const [electrons, setElectrons] = React.useState([]);

            const materials = {
                copper: { electrons: 5, color: 'bg-amber-600', freeElectronCount: 40, speed: 2 },
                aluminum: { electrons: 3, color: 'bg-gray-400', freeElectronCount: 25, speed: 1.5 },
                rubber: { electrons: 4, color: 'bg-gray-800', freeElectronCount: 0, speed: 0 }
            };

            React.useEffect(() => {
                const newAtoms = [];
                for(let r = 0; r < 5; r++) {
                    for(let c = 0; c < 8; c++) {
                        const jitter = 25;
                        newAtoms.push({
                            id: `${r}-${c}`,
                            x: c * 80 + Math.random() * jitter,
                            y: r * 80 + Math.random() * jitter
                        });
                    }
                }
                setAtoms(newAtoms);
            }, [material]);

            React.useEffect(() => {
                if (isFlowing) {
                    const leftAtoms = atoms.filter(a => a.x < 100);
                    const newElectrons = Array(materials[material].freeElectronCount)
                        .fill(0)
                        .map((_, i) => ({
                            id: i,
                            x: leftAtoms[i % leftAtoms.length].x,
                            y: leftAtoms[i % leftAtoms.length].y
                        }));
                    setElectrons(newElectrons);
                } else {
                    setElectrons([]);
                }
            }, [isFlowing, material, atoms]);

            React.useEffect(() => {
                if (isFlowing && material !== 'rubber') {
                    const interval = setInterval(() => {
                        setElectrons(prevElectrons => 
                            prevElectrons.map(electron => {
                                const jitterAmount = 3;
                                if (electron.x > 600) {
                                    const leftAtoms = atoms.filter(a => a.x < 100);
                                    const startAtom = leftAtoms[Math.floor(Math.random() * leftAtoms.length)];
                                    return {
                                        ...electron,
                                        x: startAtom.x,
                                        y: startAtom.y
                                    };
                                }
                                return {
                                    ...electron,
                                    x: electron.x + materials[material].speed,
                                    y: electron.y + (Math.random() - 0.5) * jitterAmount * materials[material].speed
                                };
                            })
                        );
                    }, 16);
                    return () => clearInterval(interval);
                }
            }, [isFlowing, material, atoms]);

            function Atom({ x, y }) {
                return (
                    <div className="absolute w-16 h-16" style={{ left: `${x}px`, top: `${y}px` }}>
                        <div className={`absolute w-8 h-8 ${materials[material].color} rounded-full left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2`} />
                        {Array(materials[material].electrons).fill(0).map((_, i) => {
                            const angle = (2 * Math.PI * i) / materials[material].electrons;
                            return (
                                <div
                                    key={i}
                                    className="absolute w-3 h-3 bg-blue-500 rounded-full"
                                    style={{
                                        left: `${Math.cos(angle) * 20 + 32}px`,
                                        top: `${Math.sin(angle) * 20 + 32}px`,
                                        transform: 'translate(-50%, -50%)'
                                    }}
                                />
                            );
                        })}
                    </div>
                );
            }

            return (
                <div className="w-full max-w-6xl mx-auto p-6">
                    <div className="flex gap-4 mb-6">
                        {Object.entries(materials).map(([key]) => (
                            <button
                                key={key}
                                onClick={() => setMaterial(key)}
                                className={`px-4 py-2 rounded ${
                                    material === key ? 'ring-2 ring-blue-500' : ''
                                } ${key !== 'rubber' ? 'bg-green-100' : 'bg-red-100'}`}
                            >
                                {key}
                            </button>
                        ))}
                        <button
                            onClick={() => setIsFlowing(!isFlowing)}
                            className={`px-4 py-2 ${isFlowing ? 'bg-red-500' : 'bg-green-500'} text-white rounded`}
                        >
                            {isFlowing ? 'Stop' : 'Start'} Flow
                        </button>
                    </div>

                    <div className="relative h-[500px] bg-gray-50 rounded-xl overflow-hidden">
                        {atoms.map(atom => (
                            <Atom key={atom.id} x={atom.x} y={atom.y} />
                        ))}
                        {electrons.map(electron => (
                            <div
                                key={electron.id}
                                className="absolute w-3 h-3 bg-blue-500 rounded-full"
                                style={{
                                    left: `${electron.x + 32}px`,
                                    top: `${electron.y + 32}px`,
                                    transform: 'translate(-50%, -50%)'
                                }}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MaterialFlow />, document.getElementById('root'));
    </script>
</body>
</html>
